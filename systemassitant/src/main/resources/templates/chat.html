<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CattleScan System Assistant</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<style>
    body, html {
        height: 100%;
        margin: 0;
    }

    .chat-wrapper {
        height: 100vh;
        display: flex;
        overflow: hidden;
    }

    /* -------- Sidebar -------- */
    #thread-sidebar {
        width: 280px;
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }

    .thread-item {
        padding: 12px;
        border-bottom: 1px solid #e5e5e5;
        cursor: pointer;
    }

    .thread-item:hover {
        background: #e9ecef;
    }

    .thread-item.active {
        background: #007bff;
        color: white;
    }

    /* -------- Chat panel -------- */
    #chat-panel {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    #chat-header {
        padding: 15px;
        background: #f1f1f1;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chat-container {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .msg-block {
        margin-bottom: 18px;
        max-width: 75%;
    }

    .msg-bubble {
        padding: 12px 16px;
        border-radius: 12px;
        white-space: pre-line;
        font-size: 15px;
        line-height: 1.35;
    }

    .user .msg-bubble {
        background: #d1e7dd;
        align-self: flex-end;
    }

    .assistant .msg-bubble {
        /* ✅ Light blue assistant background */
        background-color: #e8f4ff;
        border: 1px solid #c9e6ff;
        align-self: flex-start;
    }

    .msg-timestamp {
        font-size: 11px;
        margin-top: 4px;
        opacity: 0.7;
    }

    /* ✅ Typing indicator */
    .typing-indicator {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 12px;
        background: #e8f4ff;
        border: 1px solid #c9e6ff;
        font-size: 14px;
        font-style: italic;
        width: fit-content;
        margin-top: 6px;
        align-self: flex-start;
    }

    .typing-dots::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { color: transparent; }
        40% { color: #444; }
        60% { color: transparent; }
        80% { color: #444; }
        100% { color: transparent; }
    }

</style>

</head>

<body>

<div class="chat-wrapper">

    <!-- ✅ LEFT THREAD SIDEBAR -->
    <div id="thread-sidebar">
        <div class="p-3 border-bottom">
            <button id="new-thread-btn" class="btn btn-primary btn-block">
                + New Thread
            </button>
        </div>

        <div id="thread-list"></div>
    </div>


    <!-- ✅ RIGHT CHAT PANEL -->
    <div id="chat-panel">

        <!-- Header -->
        <div id="chat-header">
            <h5 id="thread-title">Select a thread</h5>
            <button id="rename-thread-btn" class="btn btn-sm btn-secondary" disabled>
                Rename
            </button>
        </div>

        <!-- Chat Message Area -->
        <div id="chat-container"></div>

        <!-- Input -->
        <div id="chat-input-row" class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="Type your message…" disabled>
            <div class="input-group-append">
                <button id="send-btn" class="btn btn-success" disabled>Send</button>
            </div>
        </div>

    </div>

</div>


<!-- ✅ Rename Thread Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Rename Thread</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>

            <div class="modal-body">
                <input id="rename-input" class="form-control" placeholder="New name">
            </div>

            <div class="modal-footer">
                <button id="rename-save-btn" class="btn btn-primary">Save</button>
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>

        </div>
    </div>
</div>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>

let activeThreadId = null;
const userId = "12-78";

$(document).ready(function () {
    loadThreads();

    // ✅ ENTER sends the message
    $("#message-input").keypress(function (e) {
        if (e.which === 13) {
            e.preventDefault();
            $("#send-btn").click();
        }
    });
});

/* -------------------------------------------------------
   ✅ Load Thread List
------------------------------------------------------- */
function loadThreads() {
    $.get("/api/assistant/threads?userId=" + userId, function (threads) {
        $("#thread-list").empty();

        threads.forEach(t => {
            const div = $("<div>")
                .addClass("thread-item")
                .attr("data-id", t.threadId)
                .text(t.threadName)
                .click(() => openThread(t.threadId, t.threadName));

            $("#thread-list").append(div);
        });
    });
}

/* -------------------------------------------------------
   ✅ Open Thread
------------------------------------------------------- */
function openThread(id, name) {
    activeThreadId = id;

    $(".thread-item").removeClass("active");
    $(`.thread-item[data-id='${id}']`).addClass("active");

    $("#thread-title").text(name);
    $("#rename-thread-btn").prop("disabled", false);
    $("#message-input, #send-btn").prop("disabled", false);

    $("#chat-container").empty();

    $.get("/api/assistant/thread/messages?threadId=" + id, function (messages) {
        messages.forEach(msg => appendMessage(msg.role, msg.content, msg.createdAt));
        scrollBottom();
    });
}

/* -------------------------------------------------------
   ✅ Create Thread
------------------------------------------------------- */
$("#new-thread-btn").click(function () {
    let name = prompt("Enter thread name:");
    if (!name) name = "New Thread";

    $.post("/api/assistant/thread/create?userId=" + userId + "&name=" + encodeURIComponent(name),
        function () {
            loadThreads();
        });
});

/* -------------------------------------------------------
   ✅ Rename Thread
------------------------------------------------------- */
$("#rename-thread-btn").click(function () {
    $("#renameModal").modal("show");
});

$("#rename-save-btn").click(function () {
    const newName = $("#rename-input").val().trim();
    if (!newName) return;

    $.post("/api/assistant/thread/rename",
        { threadId: activeThreadId, name: newName },
        function () {
            $("#renameModal").modal("hide");
            loadThreads();
            $("#thread-title").text(newName);
        });
});

/* -------------------------------------------------------
   ✅ Send Message
------------------------------------------------------- */
$("#send-btn").click(function () {
    const msg = $("#message-input").val().trim();
    if (!msg || !activeThreadId) return;

    appendMessage("user", msg);
    $("#message-input").val("");
    scrollBottom();

    showTyping(true);

    $.ajax({
        url: "/api/assistant/thread/send",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            threadId: activeThreadId,
            userId: userId,
            question: msg
        }),
        success: function (res) {
            showTyping(false);
            appendMessage("assistant", res.answer);
            scrollBottom();
        },
        error: function (xhr) {
            showTyping(false);
            appendMessage("assistant", "Error: " + xhr.responseText);
            scrollBottom();
        }
    });
});

/* -------------------------------------------------------
   ✅ Render Message
------------------------------------------------------- */
function appendMessage(role, text, timestamp) {
    const time = timestamp ? formatTimestamp(timestamp) : currentTime();

    let block = $("<div>").addClass("msg-block").addClass(role);
    let bubble = $("<div>").addClass("msg-bubble").html(text);
    let stamp = $("<div>").addClass("msg-timestamp").text(time);

    block.append(bubble).append(stamp);
    $("#chat-container").append(block);
}

/* -------------------------------------------------------
   ✅ Typing Indicator
------------------------------------------------------- */
let typingObj = null;

function showTyping(on) {
    if (on) {
        if (!typingObj) {
            typingObj = $("<div>")
                .addClass("typing-indicator typing-dots")
                .text("Assistant is typing");

            $("#chat-container").append(typingObj);
            scrollBottom();
        }
    } else {
        if (typingObj) {
            typingObj.remove();
            typingObj = null;
        }
    }
}

/* -------------------------------------------------------
   ✅ Timestamp Helpers
------------------------------------------------------- */
function currentTime() {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function formatTimestamp(ts) {
    return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

/* -------------------------------------------------------
   ✅ Auto-scroll
------------------------------------------------------- */
function scrollBottom() {
    const chat = $("#chat-container");
    chat.stop().animate({ scrollTop: chat.prop("scrollHeight") }, 250);
}

</script>
</body>
</html>
