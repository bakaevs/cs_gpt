<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CattleScan System Assistant</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <style>
        body, html {
            height: 100%;
            margin: 0;
        }

        .chat-wrapper {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #thread-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .thread-item {
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
        }

        .thread-item:hover {
            background: #e9ecef;
        }

        .thread-item.active {
            background: #007bff;
            color: white;
        }

        /* Chat panel */
        #chat-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #chat-header {
            padding: 15px;
            background: #f1f1f1;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-container {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 70%;
            white-space: pre-line;
        }

        .message.user {
            background: #d1e7dd;
            align-self: flex-end;
        }

        .message.assistant {
            background: #f8d7da;
            align-self: flex-start;
        }

        #chat-input-row {
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        #message-input {
            width: 85%;
            height: 40px;
            padding: 8px;
        }

        #send-btn {
            width: 14%;
        }
    </style>
</head>

<body>

<div class="chat-wrapper">

    <!-- ✅ LEFT THREAD SIDEBAR -->
    <div id="thread-sidebar">
        <div class="p-3 border-bottom">
            <button id="new-thread-btn" class="btn btn-primary btn-block">
                + New Thread
            </button>
        </div>

        <div id="thread-list"></div>
    </div>


    <!-- ✅ RIGHT CHAT PANEL -->
    <div id="chat-panel">

        <!-- Header -->
        <div id="chat-header">
            <h5 id="thread-title">Select a thread</h5>
            <button id="rename-thread-btn" class="btn btn-sm btn-secondary" disabled>
                Rename
            </button>
        </div>

        <!-- Chat Message Area -->
        <div id="chat-container"></div>

        <!-- Input -->
        <div id="chat-input-row" class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="Type your message…" disabled>
            <div class="input-group-append">
                <button id="send-btn" class="btn btn-success" disabled>Send</button>
            </div>
        </div>

    </div>

</div>


<!-- ✅ Rename Thread Modal -->
<div class="modal" id="renameModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Thread</h5>
            </div>
            <div class="modal-body">
                <input id="rename-input" class="form-control" placeholder="New name">
            </div>
            <div class="modal-footer">
                <button id="rename-save-btn" class="btn btn-primary">Save</button>
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS (modal support) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>

    let activeThreadId = null;
    const userId = "12-78";

    $(document).ready(function () {
        loadThreads();
    });


    /* ✅ Load Thread List */
    function loadThreads() {
        $.get("/api/assistant/threads?userId=" + userId, function (threads) {
            $("#thread-list").empty();

            threads.forEach(t => {
                const div = $("<div>")
                    .addClass("thread-item")
                    .attr("data-id", t.threadId)
                    .text(t.threadName)
                    .click(() => openThread(t.threadId, t.threadName));

                $("#thread-list").append(div);
            });
        });
    }


    /* ✅ Open a Thread */
    function openThread(id, name) {
        activeThreadId = id;

        $(".thread-item").removeClass("active");
        $(`.thread-item[data-id='${id}']`).addClass("active");

        $("#thread-title").text(name);
        $("#rename-thread-btn").prop("disabled", false);
        $("#message-input, #send-btn").prop("disabled", false);

        $("#chat-container").empty();

        $.get("/api/assistant/thread/messages?threadId=" + id, function (messages) {
            messages.forEach(msg => appendMessage(msg.role, msg.content));
            scrollBottom();
        });
    }


    /* ✅ Create New Thread */
    $("#new-thread-btn").click(function () {
        $.post("/api/assistant/thread/create?userId=" + userId, function (data) {
            loadThreads();
        });
    });


    /* ✅ Rename Thread */
    $("#rename-thread-btn").click(function () {
        $("#renameModal").modal("show");
    });

    $("#rename-save-btn").click(function () {
        const newName = $("#rename-input").val().trim();
        if (!newName) return;

        $.post("/api/assistant/thread/rename",
            {threadId: activeThreadId, name: newName},
            function () {
                $("#renameModal").modal("hide");
                loadThreads();
                $("#thread-title").text(newName);
            });
    });


    /* ✅ Send Message */
    $("#send-btn").click(function () {
        const msg = $("#message-input").val().trim();
        if (!msg || !activeThreadId) return;

        appendMessage("user", msg);
        $("#message-input").val("");

        $.ajax({
            url: "/api/assistant/thread/send",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                threadId: activeThreadId,
                userId: userId,
                question: msg
            }),
            success: function (res) {
                appendMessage("assistant", res.answer);
                scrollBottom();
            },
            error: function (xhr) {
                appendMessage("assistant", "Error: " + xhr.responseText);
            }
        });
    });


    /* ✅ Helper Functions */
    function appendMessage(role, text) {
        let div = $("<div>").addClass("message").addClass(role).text(text);
        $("#chat-container").append(div);
    }

    function scrollBottom() {
        const chat = $("#chat-container");
        chat.scrollTop(chat.prop("scrollHeight"));
    }

</script>

</body>
</html>
